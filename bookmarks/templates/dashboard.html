{% extends 'base.html' %}
{% block title %}Dashboard - MarkVault{% endblock %}

{% block extra_head %}
<style>
  /* ===== Hero (dark + neon) ===== */
  .hero{
    border-radius:1rem; border:1px solid var(--hx-border); padding:2rem 1.25rem;
    background:
      radial-gradient(800px 400px at -10% -20%, rgba(20, 234, 241, 0.12), transparent 60%),
      radial-gradient(600px 300px at 110% 0%, rgba(20, 182, 241, 0.08), transparent 60%),
      linear-gradient(180deg,#0f172a,#0b1220);
    position:relative;
  }
  .hero::after{
    content:''; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background-image:
      linear-gradient(rgba(20, 186, 241, 0.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(20, 212, 241, 0.05) 1px, transparent 1px);
    background-size:24px 24px; opacity:.7;
    mask-image: radial-gradient(ellipse at center, rgba(0,0,0,1) 40%, rgba(0,0,0,0) 85%);
  }

  .card{ border-radius:1rem; }
  .btn, .input-group-text{ border-radius:.75rem; }

  /* Dark inputs */
  .form-control, .form-select{
    background:#0b1220; color:var(--hx-text);
    border:1px solid var(--hx-border);
  }
  .form-control::placeholder{ color:#64748b; }
  .form-control:focus, .form-select:focus{
    border-color:var(--hx-primary-700);
    box-shadow:0 0 0 .2rem rgba(20, 215, 241, 0.15);
    background:#0b1220; color:var(--hx-text);
  }
  .input-group-text{
    background:#0b1220; color:var(--hx-muted);
    border:1px solid var(--hx-border); border-right:0;
  }

  /* Bookmark cards */
  .bookmark-card{
    background:var(--hx-card); border:1px solid var(--hx-border);
    transition: box-shadow .2s ease, transform .2s ease, border-color .2s ease;
  }
  .bookmark-card:hover{
    transform: translateY(-2px);
    box-shadow:0 12px 26px rgba(0,0,0,.45);
    border-color:rgba(20, 193, 241, 0.28);
  }

  /* Category pills (dark tints) */
  .badge{ border:1px solid var(--hx-border); }
  .badge[data-category="work"]{ background:rgba(20,241,149,.08); color:#7ee1e6; border-color:rgba(20, 186, 241, 0.25); }
  .badge[data-category="personal"]{ background:rgba(56,189,248,.08); color:#7dd3fc; border-color:rgba(56,189,248,.25); }
  .badge[data-category="study"]{ background:rgba(250,204,21,.10); color:#fde68a; border-color:rgba(250,204,21,.25); }
  .badge[data-category="entertainment"]{ background:rgba(244,114,182,.10); color:#f9a8d4; border-color:rgba(244,114,182,.25); }

  .favicon{ width:20px; height:20px; border-radius:4px; object-fit:cover; }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Hero -->
  <section class="hero bm-card bm-shadow mb-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
      <div>
        <h2 class="mb-1 bm-title">Welcome, {{ user.username }}</h2>
        <p class="bm-muted mb-0">Add new links, search, and manage your saved bookmarks below.</p>
      </div>

      <!-- Search -->
      <form method="get" action="{% url 'dashboard' %}" class="w-100 w-lg-auto" style="max-width:520px;">
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" name="q" class="form-control" placeholder="Search by title, URL, or category…" value="{{ request.GET.q }}">
          <button type="submit" class="btn btn-primary mono">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- Add Bookmark -->
  <section class="bm-card bm-shadow mb-4 p-3 p-lg-4">
    <h4 class="mb-3"><i class="fas fa-plus me-2 text-neon"></i>Add a Bookmark</h4>
    <form method="post" id="addBookmarkForm" novalidate>
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">Title</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-heading"></i></span>
            <input type="text" name="title" class="form-control" placeholder="Bookmark title" required>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <label class="form-label">URL</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-link"></i></span>
            <input type="url" name="url" class="form-control" placeholder="https://example.com" required>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <label class="form-label">Category</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-tags"></i></span>
            <select name="category" class="form-select">
              <option value="work">Work</option>
              <option value="personal">Personal</option>
              <option value="study">Study</option>
              <option value="entertainment">Entertainment</option>
            </select>
          </div>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary w-100 mono">
            <i class="fas fa-bookmark me-1"></i> Add Bookmark
          </button>
        </div>
      </div>
    </form>
  </section>

  <!-- Bookmarks Grid -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0">Your Bookmarks</h4>
    {% if request.GET.q %}
      <span class="bm-muted small">Results for “{{ request.GET.q }}”</span>
    {% endif %}
  </div>

  <div class="row g-3">
    {% for bookmark in bookmarks %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="bookmark-card p-3 h-100 d-flex flex-column">
          <div class="d-flex align-items-start gap-2">
            <img class="favicon" src="https://www.google.com/s2/favicons?sz=64&domain_url={{ bookmark.url }}" alt="">
            <div class="flex-grow-1">
              <a href="{{ bookmark.url }}" class="bm-link fw-semibold text-truncate d-inline-block" style="max-width: 100%;" target="_blank" rel="noopener noreferrer">
                {{ bookmark.title }}
              </a>
              <div class="small text-truncate bm-muted">{{ bookmark.url }}</div>
              <div class="mt-2">
                <span class="badge rounded-pill px-2 py-1" data-category="{{ bookmark.category }}">{{ bookmark.get_category_display }}</span>
              </div>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <a href="{{ bookmark.url }}" target="_blank" rel="noopener noreferrer"
               class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Open">
              <i class="fas fa-external-link-alt"></i>
            </a>

            <button type="button" class="btn btn-sm btn-outline-secondary"
                    data-copy="{{ bookmark.url }}" data-bs-toggle="tooltip" title="Copy URL">
              <i class="far fa-copy"></i>
            </button>

            <a href="{% url 'edit_bookmark' bookmark.id %}"
               class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Edit">
              <i class="fas fa-edit"></i>
            </a>

            <a href="{% url 'delete_bookmark' bookmark.id %}"
               class="btn btn-sm btn-outline-danger" data-delete data-bs-toggle="tooltip" title="Delete">
              <i class="fas fa-trash-alt"></i>
            </a>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12">
        <div class="bm-card p-4 text-center bm-shadow">
          <i class="fas fa-box-open fa-2x mb-2"></i>
          <p class="mb-0 bm-muted">No bookmarks yet. Add your first one above!</p>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Bootstrap tooltips
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=>{
    new bootstrap.Tooltip(el);
  });

  // Copy URL
  document.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(btn.getAttribute('data-copy'));
        Swal.fire({icon:'success', title:'Copied', text:'Link copied to clipboard.', timer:1400, showConfirmButton:false});
      }catch(e){
        Swal.fire({icon:'error', title:'Failed', text:'Could not copy link.'});
      }
    });
  });

  // Delete confirm
  document.querySelectorAll('[data-delete]').forEach(link=>{
    link.addEventListener('click', (e)=>{
      e.preventDefault();
      Swal.fire({
        icon:'warning',
        title:'Delete this bookmark?',
        text:'This action cannot be undone.',
        showCancelButton:true,
        confirmButtonText:'Delete',
        confirmButtonColor:'#d33'
      }).then(res=>{
        if(res.isConfirmed){ window.location.href = link.getAttribute('href'); }
      });
    });
  });

  // Add form UI validation
  document.getElementById('addBookmarkForm')?.addEventListener('submit', (e)=>{
    const title = e.target.querySelector('input[name="title"]').value.trim();
    const url = e.target.querySelector('input[name="url"]').value.trim();
    if(!title || !url){
      e.preventDefault();
      Swal.fire({ icon:'warning', title:'Missing fields', text:'Please fill both Title and URL.' });
    }
  });
</script>
{% endblock %}
